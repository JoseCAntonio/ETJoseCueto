{% extends "./principal.html" %}

{% block body %}
{% load static %}

<header class="py-2" style="background-color: #3b5998;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-auto">
               <h3 style="color: white;">
                   BernarPost
               </h3>
            </div>
            <div class="col">
                <form class="form-inline">
                    <input class="form-control mr-sm-2" type="search" placeholder="Buscar" aria-label="Buscar">
                </form>
            </div>
            <div class="col-auto">
                <h3 style="color: white;">B</h3>
            </div>
        </div>
    </div>
</header>

<main class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <nav class="nav flex-column p-3" style="background-color: #3b5998; border-radius: 10px;">
                <a class="nav-link" href="{% url 'admin' %}" style="color: white;">Admin</a>
                <a class="nav-link active" href="{% url 'novedades' %}" style="color: white;">Novedades</a>
                <a class="nav-link" href="{% url 'panoramas' %}" style="color: white;">Panoramas</a>
                <a class="nav-link" href="{% url 'carrito' %}" style="color: white;">Carrito</a>

            </nav>
        </div>
        <div class="col-md-9">
            <div class="mb-4">
                <h3>¿Qué está ocurriendo?</h3>
                <form id="post-form" style="background-color: #f5f6f7; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                    {% csrf_token %}
                    <div class="form-group">
                        <textarea class="form-control" id="post-text" name="post-text" rows="4" placeholder="Comparte algo" style="resize: none; font-size: 18px; border-radius: 10px; padding: 15px;" required></textarea>
                    </div>
                    <div class="form-group">
                        <input class="form-control" type="text" id="post-username" name="post-username" placeholder="Ingresa tu nombre" style="font-size: 18px; border-radius: 10px; padding: 15px;" required>
                    </div>
                    <div class="form-group">
                        <input class="form-control" type="text" id="post-image-url" name="post-image-url" placeholder="Ingresa la URL de la imagen" style="font-size: 18px; border-radius: 10px;">
                    </div>
                    <button type="button" class="btn btn-primary btn-block" onclick="addPost()" style="font-size: 18px; padding: 10px; border-radius: 10px;">Publicar</button>
                </form>
            </div>

            <div id="feed">
                <div class="card mb-3" style="border: 1px solid #3b5998; border-radius: 10px;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-0">Rosa Perez</h5>
                                <small class="text-muted">Hace 1 hora</small>
                            </div>
                        </div>
                        <p class="card-text">Buenos días vecinos, ocurrió un accidente en San José, por favor cambien su trayecto si deben ir por San José, ya que está cerrado.</p>
                        <img src="https://abogacia-us.com/wp-content/uploads/2019/07/valor-de-mi-caso-de-accidente-auto.jpg" alt="Post Image" class="img-fluid mb-3" style="border-radius: 10px;">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-light"><i class="icon-thumbs-up"></i> Me gusta</button>
                            <button class="btn btn-light"><i class="icon-chat"></i> Comentar</button>
                        </div>
                    </div>
                </div>

                <!-- Segundo post de muestra -->
                <div class="card mb-3" style="border: 1px solid #3b5998; border-radius: 10px;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-0">Municipalidad de San Bernardo</h5>
                                <small class="text-muted">Hace 2 horas</small>
                            </div>
                        </div>
                        <p class="card-text">Buenos días Sanbernardinos, hoy 3 de junio de 2024 hay demasiado tráfico en el centro.</p>
                        <img src="https://static.emol.cl/emol50/Fotos/2018/10/24/file_20181024135400.jpg" alt="Post Image" class="img-fluid mb-3" style="border-radius: 10px;">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-light"><i class="icon-thumbs-up"></i> Me gusta</button>
                            <button class="btn btn-light"><i class="icon-chat"></i> Comentar</button>
                        </div>
                    </div>
                </div>
                {% for post in posts %}
                <div class="card mb-3" style="border: 1px solid #3b5998; border-radius: 10px;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-0">{{ post.username }}</h5>
                                <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                            </div>
                        </div>
                        
                        <p class="card-text">{{ post.text }}</p>
                        {% if post.image_url %}
                        <img src="{{ post.image_url }}" alt="Post Image" class="img-fluid mb-3" style="border-radius: 10px;">
                        {% endif %}
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-light"><i class="icon-thumbs-up"></i> Me gusta</button>
                            <button class="btn btn-light"><i class="icon-chat"></i> Comentar</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</main>

<footer class=" py-3 mt-4" style="background-color: #3b5998;">
    <div class="container text-center">
        <h5 style="color: white;">BernarPost©</h5>
    </div>
</footer>

<script>
    function addPost() {
        var postText = document.getElementById('post-text').value;
        var postImageUrl = document.getElementById('post-image-url').value;
        var postUsername = document.getElementById('post-username').value;
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (postText && postUsername) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "registrarPost" %}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var post = JSON.parse(xhr.responseText);
                    var newPost = document.createElement('div');
                    newPost.className = 'card mb-3';
                    newPost.style.border = '1px solid #3b5998';
                    newPost.style.borderRadius = '10px';
                    newPost.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div>
                                    <h5 class="card-title mb-0">${post.username}</h5>
                                    <small class="text-muted">Justo ahora</small>
                                </div>
                            </div>
                            <p class="card-text">${post.text}</p>
                            ${post.image_url ? `<img src="${post.image_url}" alt="Post Image" class="img-fluid mb-3" style="border-radius: 10px;">` : ''}
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-light"><i class="icon-thumbs-up"></i> Me gusta</button>
                                <button class="btn btn-light"><i class="icon-chat"></i> Comentar</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('feed').prepend(newPost);
                    document.getElementById('post-form').reset();
                } else {
                    alert('Hubo un problema al publicar.');
                }
            };
            xhr.send('post-text=' + encodeURIComponent(postText) + '&post-username=' + encodeURIComponent(postUsername) + '&post-image-url=' + encodeURIComponent(postImageUrl));
        } else {
            alert("Por favor, completa todos los campos requeridos.");
        }
    }
</script>

{% endblock %}
